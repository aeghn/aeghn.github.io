<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8"/>
<link rel="alternate"
      type="application/rss+xml"
      href="https://wangz.me/rss.xml"
      title="RSS feed for https://wangz.me/"/>
<title>如何在无法显卡直通的 KVM 使用愉快地使用 Windows -- wangz.me</title>
<meta name="author" content="Aeghn"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href= "static/style.css" rel="stylesheet" type="text/css" />
<link rel="icon" href="static/favicon.ico"/></head>
<body>
<div id="preamble" class="status"><div id="blog-nav">
  <a href="/">wangz's blog </a>
  <span>/ </span>
  <a href="/tags.html">Tags </a>
</div><hr/></div>
<div id="content">
<div class="post-item">
   <div class="post-date"><span class="day">24</span> <span class="month">Nov</span> <span class="year">2021</span></div>
   <div class="post-title-and-tags">
   <h1 class="post-title"><a href="https://wangz.me/2021-11-27-live_happily_with_windows.html"> 如何在无法显卡直通的 KVM 使用愉快地使用 Windows </a></h1>

   <div class="post-tags"><a href="https://wangz.me/tag-windows.html">Windows</a> <a href="https://wangz.me/tag-linux.html">Linux</a> <a href="https://wangz.me/tag-kvm.html">KVM</a> <a href="https://wangz.me/tag-i3wm.html">i3wm</a> <a href="https://wangz.me/tag-xkeysnail.html">xkeysnail</a> </div>
   </div>
   </div>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge4b3a58">1. 「引」</a></li>
<li><a href="#org9f5ad7f">2. 在物理硬盘上安装 Windows</a></li>
<li><a href="#org6961d07">3. 直通硬盘中的 Windows 到 Qemu 中进行启动</a></li>
<li><a href="#orgba98303">4. 使用 FreeRDP 链接</a></li>
<li><a href="#orgc45cbb4">5. 与 i3wm（或者其他 Window Manager） 交互</a>
<ul>
<li><a href="#org284812b">5.1. xkeysnail 配置参考如下：</a></li>
<li><a href="#org4dc2c3b">5.2. 使用 Super-Control-w 切换当前工作区和 Windows Guest 所在工作区</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<blockquote>
<p>
Windows 就应该活在虚拟机里。
</p>
</blockquote>

<div id="outline-container-orge4b3a58" class="outline-2">
<h2 id="orge4b3a58"><span class="section-number-2">1.</span> 「引」</h2>
<div class="outline-text-2" id="text-1">
<p>
本文简要地描述了怎么在 GNU/Linux 下愉快地使用无显卡直通的 Windows 虚拟机。
</p>
</div>
</div>

<div id="outline-container-org9f5ad7f" class="outline-2">
<h2 id="org9f5ad7f"><span class="section-number-2">2.</span> 在物理硬盘上安装 Windows</h2>
<div class="outline-text-2" id="text-2">
<p>
网上有大把教程，不再赘述。
</p>

<p>
另外推荐 Windows 10 Ltsc 2019，该系统受支持到 2029 年。「当然需要获得获得正版授权」。
</p>

<p>
而且今年发布的 Windows 10 Ltsc 2021 也只有五年支持，还封装了 WSL 之类的组件。我之后的使用场景主要是 Linux Host + Windows Guest，所以 Ltsc 2021 对我来说，非但没有延长支持时间，还带来了累赘，增大了性能消耗。
</p>
</div>
</div>

<div id="outline-container-org6961d07" class="outline-2">
<h2 id="org6961d07"><span class="section-number-2">3.</span> 直通硬盘中的 Windows 到 Qemu 中进行启动</h2>
<div class="outline-text-2" id="text-3">
<p>
启动命令如下
</p>
<div class="org-src-container">
<pre class="src src-bash">pkexec qemu-system-x86_64 \
       -name "${QEMU_CLASS}",process="${QEMU_CLASS}" \
       -daemonize \
       -enable-kvm \
       -cpu host,kvm=on,+hypervisor,+invtsc,l3-cache=on,migratable=no,hv_frequencies,kvm_pv_unhalt,hv_reenlightenment,hv_relaxed,hv_spinlocks=8191,hv_stimer,hv_synic,hv_time,hv_vapic,hv_vendor_id=1234567890ab,hv_vpindex,topoext \
       -m 8192 \
       -smp cores=4,threads=2,sockets=1 \
       -machine q35 \
       -drive if=pflash,format=raw,readonly=on,file="$OVMF" \
       -net nic -net user,hostfwd=tcp::${LOCAL_PORT}-:3389 \
       -nodefaults \
       --display none \
       -drive format=raw,file=/dev/nvme0n1 \
       -drive format=raw,file=/dev/sdb
</pre>
</div>

<p>
这里直通了 Windows 所在的整个磁盘，这种情况下的 IO 可以说是最好的，消耗很少。比 Qcow2 之类的还要棒。
</p>

<p>
不需要任何图形，因为之后我们使用 rdp 显示图形。
</p>
</div>
</div>

<div id="outline-container-orgba98303" class="outline-2">
<h2 id="orgba98303"><span class="section-number-2">4.</span> 使用 FreeRDP 链接</h2>
<div class="outline-text-2" id="text-4">
<p>
由 Gentoo 群的部分群友提示，使用 rdp 链接要比直接使用 spice 更好一些，实际体验确实如此，spice 占用了更多的资源但是表现并不如 rdp 流程。
</p>

<p>
以下是使用 rdp 进行链接的方法
</p>
<div class="org-src-container">
<pre class="src src-bash">xfreerdp /u:******** /p:************ /v:127.0.0.1:10322 \
         /w:1600 /h:900 /bpp:32 \
         /dynamic-resolution \
         +clipboard +fonts \
         /gdi:hw \
         /rfx /rfx-mode:video \
         /sound:sys:pulse \
         +menu-anims +window-drag  \
         /drive:home,${GUEST_HOME_DIR} \
         +auto-reconnect \
         /wm-class:"FOO_WINDOW_CLASS" &amp;!
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc45cbb4" class="outline-2">
<h2 id="orgc45cbb4"><span class="section-number-2">5.</span> 与 i3wm（或者其他 Window Manager） 交互</h2>
<div class="outline-text-2" id="text-5">
<p>
在 X11 下有这样一个问题，就是因为 qemu 和 rdp 会抓住整个键盘，所以所有快捷键的直接操作对象都是虚拟机中的内容。
</p>

<p>
这在 KDE/Gnome 下是没啥问题的，因为这种大型 DE 用户的主要操作习惯还是依靠鼠标。但是我的主要操作环境是 i3wm，一个主要依靠 <code>Super</code> 修饰键的窗口管理器。
</p>

<p>
在该 WM 中，主要通过 <code>Super+&lt;NUM&gt;</code> 来进行工作区的切换，但是由于 Windows 直接拦截了这些快捷键，所以如果在需要切换工作区的话，就需要鼠标点击，或者将鼠标移出 rdp 窗口才能切换工作区，比较繁琐。
</p>

<p>
之前比较讨厌 <code>xkeysnail</code> 所以，想到的都是使用 Auto Hot Key 在 Windows 中抓到后在使用 rest 之类的方法传到 Host 上，调用 <code>i3-msg</code> 命令进行其他各种操作，相关过程见 <a href="https://emacs-china.org/t/qemu-kvm-virtual-machine-manger-windows10-i3wm-win-num-workspace/18331/2">qemu/kvm(virtual machine manger) windows10虚拟机和i3wm win+num 切换workspace冲突问题大家有解决过吗</a>。
</p>

<p>
但是最近开始用 60% 的小键盘了，不得不使用 xkeysnail 这样的按键来将映射一批方向键（emacs 风格的），所以针对使用 xkeysnail 的用户有一套更简单的方式，因为 xkeysnail 直接在 <code>evdev</code> 和 <code>uinput</code> 上运行的，所以就可以直接在该层读取后直接调用 <code>i3-msg</code> 命令。
</p>
</div>

<div id="outline-container-org284812b" class="outline-3">
<h3 id="org284812b"><span class="section-number-3">5.1.</span> xkeysnail 配置参考如下：</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-python">define_keymap(re.compile("w10ltscqemu|w10ltscrdp"), {
    # Ctrl+Alt+j/k to switch next/previous tab
    K("Super-KEY_1"): launch(["i3-msg", "workspace", "1"]),
    K("Super-KEY_2"): launch(["i3-msg", "workspace", "2"]),
    K("Super-KEY_3"): launch(["i3-msg", "workspace", "3"]),
    K("Super-KEY_4"): launch(["i3-msg", "workspace", "4"]),
    K("Super-KEY_5"): launch(["i3-msg", "workspace", "5"]),
    K("Super-KEY_6"): launch(["i3-msg", "workspace", "6"]),
    K("Super-KEY_7"): launch(["i3-msg", "workspace", "7"]),
    K("Super-KEY_8"): launch(["i3-msg", "workspace", "8"]),

    K("Super-Shift-q"): K("M-F4"),
    K("Super-C-w"): launch(["/home/chin/.scripts/show_windows"])
}, "Windows guest")
</pre>
</div>

<p>
其中的 <code>/home/chin</code> 是我的 home 目录。
</p>
</div>
</div>

<div id="outline-container-org4dc2c3b" class="outline-3">
<h3 id="org4dc2c3b"><span class="section-number-3">5.2.</span> 使用 Super-Control-w 切换当前工作区和 Windows Guest 所在工作区</h3>
<div class="outline-text-3" id="text-5-2">
<p>
以下的 bash 函数可以做到在 windows guest 工作区和当前工作区切换的功能。
</p>

<ul class="org-ul">
<li>但是需要注意的是 i3wm 需要开启 <code>workspace_auto_back_and_forth yes</code></li>

<li>将以下脚本保存到 <code>$HOME/.scripts/show_windows</code> 文件 <br>
保存到什么位置都可以，只要和 xkeysnail 中的配置对应即可。</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash">#!/usr/bin/env bash

show_windows() {
    local num=$(i3-msg -t get_tree | jq -r '.nodes[].nodes[] | recurse(.nodes[], .floating_nodes[]) | select(.type == "workspace")  | .num as $WSN |  recurse(.nodes[], .floating_nodes[]) | select(.window_properties.class == "FOO_WINDOW_CLASS") | $WSN')
    i3-msg "workspace $num"
}

show_windows
</pre>
</div>

<p>
上文中的 <code>FOO_WINDOW_CLASS</code> 需要进行修改，匹配自己的目标 Window Class.
</p>
</div>
</div>
</div>
<div id="post-meta"><div class="post-tags">相关标签：<a href="https://wangz.me/tag-windows.html">Windows</a> <a href="https://wangz.me/tag-linux.html">Linux</a> <a href="https://wangz.me/tag-kvm.html">KVM</a> <a href="https://wangz.me/tag-i3wm.html">i3wm</a> <a href="https://wangz.me/tag-xkeysnail.html">xkeysnail</a> </div><div class="post-date-published">最后更新：2021-11-28</div><div class="post-date-created">首次发布：2021-11-24</div><div class="post-tags">联系邮箱：aeghn_at_outlook_dot_com</div></div></div>
<div id="postamble" class="status">
<center><span> Powered by Org-mode and</span> <a href="https://github.com/aeghn/org-static-blog"> a fork</a><span> of</span><a href="https://github.com/bastibe/org-static-blog"> org-static-blog</a> </center></div>
</body>
</html>
